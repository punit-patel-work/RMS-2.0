# RMS2 — Architecture Document

## 1. Folder Structure

```
RMS2/
├── prisma/
│   ├── SCHEMA.prisma           # Database schema (source of truth)
│   ├── migrations/             # Auto-generated by `prisma migrate`
│   └── seed.ts                 # Dev seed data (tables, menu, users)
│
├── src/
│   ├── app/
│   │   ├── layout.tsx          # Root layout — dark-mode body, font loading
│   │   ├── page.tsx            # Redirect → /login or /pos
│   │   │
│   │   ├── (auth)/
│   │   │   └── login/
│   │   │       └── page.tsx    # PIN pad login screen
│   │   │
│   │   ├── (dashboard)/        # Route group — all authenticated pages
│   │   │   ├── layout.tsx      # Sidebar + role-gated nav
│   │   │   │
│   │   │   ├── pos/
│   │   │   │   ├── page.tsx            # Table grid view (entry point)
│   │   │   │   └── [tableId]/
│   │   │   │       └── page.tsx        # Cart / Order builder for a table
│   │   │   │
│   │   │   ├── kds/
│   │   │   │   └── page.tsx            # Kitchen Display (polling view)
│   │   │   │
│   │   │   └── admin/
│   │   │       ├── menu/
│   │   │       │   └── page.tsx        # Menu CRUD + 86 toggle
│   │   │       ├── promotions/
│   │   │       │   └── page.tsx        # Promotion manager
│   │   │       ├── tables/
│   │   │       │   └── page.tsx        # Table layout manager
│   │   │       └── analytics/
│   │   │           └── page.tsx        # Sales reports
│   │   │
│   │   └── api/
│   │       ├── auth/[...nextauth]/
│   │       │   └── route.ts            # Auth.js catch-all handler
│   │       └── kds/
│   │           └── active/
│   │               └── route.ts        # GET — polled by KDS every 5 s
│   │
│   ├── server/
│   │   ├── actions/                    # Next.js Server Actions
│   │   │   ├── order.actions.ts        # fireOrder, voidOrder, payOrder
│   │   │   ├── table.actions.ts        # updateTableStatus
│   │   │   ├── menu.actions.ts         # CRUD menu items + categories
│   │   │   └── promotion.actions.ts    # CRUD promotions
│   │   │
│   │   └── queries/                    # Read-only data fetchers
│   │       ├── order.queries.ts
│   │       ├── table.queries.ts
│   │       ├── menu.queries.ts
│   │       ├── promotion.queries.ts
│   │       └── analytics.queries.ts
│   │
│   ├── lib/
│   │   ├── prisma.ts                   # Singleton PrismaClient
│   │   ├── auth.ts                     # Auth.js config (Credentials provider)
│   │   ├── auth.config.ts              # Edge-compatible auth config
│   │   ├── utils.ts                    # cn(), formatCurrency(), etc.
│   │   └── pricing.ts                  # Pure fn: calcEffectivePrice(item, promos)
│   │
│   ├── stores/
│   │   └── cart-store.ts               # Zustand — client-side cart state
│   │
│   ├── hooks/
│   │   ├── use-kds-orders.ts           # SWR hook: polls /api/kds/active
│   │   └── use-connection-status.ts    # Navigator.onLine + toast
│   │
│   ├── components/
│   │   ├── ui/                         # Shadcn UI primitives (auto-generated)
│   │   ├── pos/
│   │   │   ├── table-grid.tsx          # Color-coded table tiles
│   │   │   ├── cart-panel.tsx          # Sidebar cart with promo calc
│   │   │   └── category-tabs.tsx       # Horizontal menu category nav
│   │   ├── kds/
│   │   │   ├── kds-card.tsx            # Single order card with aging border
│   │   │   └── bump-button.tsx         # Tap-to-complete button
│   │   ├── admin/
│   │   │   ├── menu-item-form.tsx      # RHF + Zod menu editor
│   │   │   └── promo-form.tsx          # RHF + Zod promotion editor
│   │   └── shared/
│   │       ├── sidebar.tsx             # Role-gated navigation
│   │       ├── connection-toast.tsx    # "Connection Lost" banner
│   │       └── page-header.tsx
│   │
│   ├── types/
│   │   └── index.ts                    # Shared TS types & Zod schemas
│   │
│   └── middleware.ts                   # Auth.js middleware — route protection
│
├── public/                             # Static assets
├── .env                                # DATABASE_URL, AUTH_SECRET
├── tailwind.config.ts
├── next.config.ts
├── tsconfig.json
└── package.json
```

---

## 2. State Management Strategy

| Concern | Tool | Rationale |
|:--------|:-----|:----------|
| **Cart (POS order builder)** | **Zustand** | Client-only ephemeral state. Cart lives in memory, persisted to `sessionStorage`. Reset after "Fire Order". |
| **KDS live orders** | **SWR** (`refreshInterval: 5000`) | Declarative polling with stale-while-revalidate. Automatic deduplication & error retry. |
| **Server data (tables, menu, orders)** | **Server Components + Server Actions** | No client cache needed. Data is read fresh on every page load via RSC. Mutations go through Server Actions. |
| **Auth session** | **Auth.js v5** | JWT strategy. Session available server-side via `auth()` and client-side via `useSession()`. |

### Cart Store Shape (Zustand)

```ts
interface CartStore {
  tableId: string | null;
  items: CartItem[];              // { menuItemId, name, quantity, unitPrice, notes }
  promotions: ActivePromotion[];  // applied promos from server
  subtotal: number;               // Derived: Σ(unitPrice × qty)
  discount: number;               // Derived: from promotion calc
  total: number;                  // Derived: subtotal − discount

  addItem: (item: MenuItem) => void;
  removeItem: (menuItemId: string) => void;
  updateQuantity: (menuItemId: string, qty: number) => void;
  setNotes: (menuItemId: string, notes: string) => void;
  reset: () => void;
}
```

---

## 3. Data Flow Diagrams

### A. POS "Fire Order" Flow

```
┌──────────┐     ┌─────────────┐     ┌────────────────────┐
│  Tablet   │     │  Zustand    │     │  Server Action     │
│  (Touch)  │────▶│  Cart Store │────▶│  fireOrder()       │
└──────────┘     └─────────────┘     │                    │
                                      │ 1. Validate items  │
                                      │ 2. Calc frozenPrice│
                                      │ 3. Create Order +  │
                                      │    OrderItems in   │
                                      │    single tx       │
                                      │ 4. Update Table →  │
                                      │    OCCUPIED        │
                                      │ 5. Return orderId  │
                                      └────────────────────┘
                                               │
                                      Cart.reset() ← on success
```

### B. KDS Polling Flow

```
┌──────────────┐    GET /api/kds/active    ┌──────────────────┐
│  KDS Page    │◀──── SWR (5 s) ──────────▶│  Route Handler   │
│  (useSWR)    │                            │                  │
│              │    JSON: Order[]           │  Prisma query:   │
│  ┌────────┐  │◀───────────────────────────│  status = OPEN   │
│  │Card    │  │                            │  include items   │
│  │(aging) │  │    "Bump" tap              │  where PENDING   │
│  └────────┘──│───── Server Action ───────▶│  → mark READY    │
└──────────────┘    bumpItem(itemId)         └──────────────────┘
```

### C. Promotion Pricing Flow (Non-Destructive)

```
1. Admin creates Promotion (scope: ITEM or CATEGORY, type: FIXED/PERCENT)
2. Promotion stored in `Promotion` table — MenuItem.basePrice UNTOUCHED
3. At POS cart time:
   a. Fetch active promotions for items in cart
   b. calcEffectivePrice(item, promos) → returns discounted price
   c. Cart displays basePrice with strikethrough + effective price
4. On "Fire Order":
   a. frozenPrice = effective price (after promo)
   b. Stored permanently on OrderItem — immune to future price/promo changes
```

---

## 4. Auth & Middleware Strategy

- **Provider:** `CredentialsProvider` — staff log in with a numeric PIN.
- **JWT payload:** `{ id, name, role }` — no database session lookups.
- **Middleware (`middleware.ts`):**
  - Protects all `/pos/*`, `/kds/*`, `/admin/*` routes.
  - Role matrix:
    - `FLOOR_STAFF` → `/pos`, `/kds`
    - `KITCHEN_STAFF` → `/kds`
    - `SUPERVISOR` → `/pos`, `/kds`, `/admin` (except user mgmt)
    - `OWNER` → full access

---

## 5. Offline / Connectivity Strategy

- **Primary:** Server-side rendering; all mutations are Server Actions (internet required).
- **Backup:** Venue has a 5G failover router.
- **UX:** `useConnectionStatus` hook monitors `navigator.onLine` + periodic fetch heartbeat.
  - On disconnect → sticky toast: *"Connection lost — orders cannot be saved"*.
  - On reconnect → toast auto-dismisses, SWR revalidates.
